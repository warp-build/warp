syntax = "proto3";
package build.warp.codedb;

import "schemas/build/warp/common.proto";

service AnalyzerService {
  rpc GetDependencies(GetDependenciesRequest) returns (GetDependenciesResponse);

  rpc GetInterestedPaths(GetInterestedPathsRequest) returns (GetInterestedPathsResponse);

  rpc GetProvidedSymbols(GetProvidedSymbolsRequest) returns (GetProvidedSymbolsResponse);

  rpc GetAst(GetAstRequest) returns (GetAstResponse);

  rpc GenerateSignature(GenerateSignatureRequest) returns (GenerateSignatureResponse);
}

message GetDependenciesRequest {
  string workspace_root = 1;
  repeated string profiles = 2;
}

message GetDependenciesResponse {
  Status status = 1;
  repeated Dependency dependencies = 2;
}

message GenerateSignatureRequest {
  string file = 1;
  repeated Dependency dependencies = 2;
  Symbol symbol = 3;
}

message GenerateSignatureResponse {
  oneof response {
    GenerateSignatureSuccessResponse ok = 1;
    GenerateSignatureMissingDepsResponse missing_deps = 3;
  }
}

message GenerateSignatureSuccessResponse {
  Status status = 1;
  string file = 2;
  string json_signature = 3;
  repeated Signature signatures = 4;
}

message GenerateSignatureMissingDepsResponse {
  string file = 1;
  Symbol symbol = 2;
  repeated Requirement dependencies = 3;
}

message GetAstRequest {
  string file = 1;
  Symbol symbol = 2;
  repeated Dependency dependencies = 3;
}

message GetAstResponse {
  oneof response {
    GetAstSuccessResponse ok = 1;
    GetAstMissingDepsResponse missing_deps = 3;
  }
}

message GetAstMissingDepsResponse {
  string file = 1;
  Symbol symbol = 2;
  repeated Requirement dependencies = 3;
}

message GetAstSuccessResponse {
  string file = 1;
  Symbol symbol = 2;
  string source = 3;
  string ast = 4;
}

message GetInterestedPathsRequest {}

message GetInterestedPathsResponse {
  repeated string build_files = 1;
  repeated string test_files = 2;
}

message GetProvidedSymbolsRequest {
  string file = 1;
}

message GetProvidedSymbolsResponse {
  bool skipped = 1;
  string file = 2;
  repeated Requirement provides = 3;
}
