syntax = "proto3";
package build.warp.codedb;

import "google/protobuf/struct.proto";

service AnalyzerService {
  rpc GetInterestedPaths(GetInterestedPathsRequest) returns (GetInterestedPathsResponse);

  rpc GetProvidedSymbols(GetProvidedSymbolsRequest) returns (GetProvidedSymbolsResponse);

  rpc GetAst(GetAstRequest) returns (GetAstResponse);

  rpc GenerateSignature(GenerateSignatureRequest) returns (GenerateSignatureResponse);
}

enum Status {
  STATUS_UNKNOWN = 0;
  STATUS_OK = 1;
  STATUS_ERR = 2;
}

message GenerateSignatureRequest {
  string file = 1;
}

message GenerateSignatureResponse {
  Status status = 1;
  string file = 2;
  string json_signature = 3;
  repeated Signature signatures = 4;
}

message Signature {
  string name = 1;
  string rule = 2;
  repeated Requirement deps = 3;
  repeated Requirement runtime_deps = 4;
  google.protobuf.Struct config = 5;
}

message GetAstRequest {
  string file = 1;
  Symbol symbol = 2;
}

message GetAstResponse {
  Status status = 1;
  string file = 2;
  Symbol symbol = 3;
  string source = 4;
  string ast = 5;
}

message Symbol {
  oneof sym {
    bool all = 1;
    string named = 2;
  }
}

message GetInterestedPathsRequest {}

message GetInterestedPathsResponse {
  repeated string build_files = 1;
  repeated string test_files = 2;
}

message GetProvidedSymbolsRequest {
  string file = 1;
}

message GetProvidedSymbolsResponse {
  bool skipped = 1;
  string file = 2;
  repeated Requirement provides = 3;
}

message FileRequirement {
  string path = 1;
}

message SymbolRequirement {
  string raw = 1;
  string kind = 2;
}

message Requirement {
  oneof requirement {
    FileRequirement file = 1;
    SymbolRequirement symbol = 2;
  }
}

